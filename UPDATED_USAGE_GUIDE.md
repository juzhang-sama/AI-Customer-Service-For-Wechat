# 📖 更新后的使用指南

## 🎯 核心改进

### 1. 简化的监听机制
- ❌ 废弃：复杂的多关键词匹配规则
- ✅ 新增：全局唯一监听关键词 "X"
- 💡 原理：只监听联系人名称以 "X" 开头的会话

### 2. 灵活的 AI 专家选择
- ❌ 废弃：自动关键词匹配 AI 专家
- ✅ 新增：用户手动选择 AI 专家
- 💡 原理：生成回复时从下拉菜单选择

---

## 📋 使用步骤

### 步骤 1: 设置监听关键词

1. 打开系统设置页面（点击左侧菜单"系统设置"）
2. 在"全局监听关键词"输入框中输入关键词，例如：`客户`
3. 点击"保存配置"
4. **重启后端服务**（重要！）

```bash
# 停止后端（Ctrl+C）
# 重新启动
python python/app.py
```

### 步骤 2: 规范微信联系人命名

在微信中，将需要监听的联系人备注修改为：

```
关键词-姓名

例如：
客户-张三
客户-李四
客户-王五
```

**重要**：
- 联系人名称必须以关键词开头
- 关键词区分大小写
- 不符合格式的联系人不会被监听

### 步骤 3: 创建 AI 专家配置

1. 打开"AI 专家搭建"页面
2. 点击"新建配置"
3. 填写配置信息：
   - 配置名称：例如"医美销售专家"
   - 角色定义：描述 AI 的角色
   - 业务逻辑：设置回复规则
   - 语气风格、回复长度等
4. 点击"保存配置"

**提示**：可以创建多个 AI 专家配置，用于不同场景。

### 步骤 4: 监听和回复消息

1. 打开"消息中心"
2. 等待微信同步消息（会话列表会自动更新）
3. 点击某个会话，查看消息内容
4. 在右侧"AI 智能回复"面板：
   - **选择 AI 专家**（下拉菜单）
   - 点击"生成回复"
5. 查看三个版本的回复建议
6. 选择合适的版本，点击"复制"或"发送"

---

## 🔍 工作原理

### 监听机制

```
微信窗口
  ↓
扫描会话列表 (0.5秒/次)
  ↓
解析会话名称
  ↓
检查是否以关键词开头 ← 全局唯一关键词
  ↓
是 → 推送到前端
否 → 跳过
```

### AI 专家选择

```
用户点击"生成回复"
  ↓
从下拉菜单选择 AI 专家 ← 用户手动选择
  ↓
调用后端 API
  ↓
使用选择的 AI 专家配置
  ↓
生成三个版本的回复
```

---

## 📊 示例场景

### 场景 1: 医美行业

**设置**:
- 监听关键词：`客户`
- AI 专家配置：
  - 医美销售专家
  - 售后服务专家
  - 预约专员

**微信联系人命名**:
```
客户-张三-热玛吉咨询
客户-李四-水光针
客户-王五-光子嫩肤
```

**使用流程**:
1. 客户发送消息："热玛吉多少钱？"
2. 消息中心显示新消息
3. 选择"医美销售专家"
4. 生成回复
5. 选择合适的版本发送

### 场景 2: 代理商管理

**设置**:
- 监听关键词：`代理`
- AI 专家配置：
  - 代理商专家
  - 区域经理专家

**微信联系人命名**:
```
代理-北京-张总
代理-上海-李总
代理-广州-王总
```

---

## ⚙️ 配置文件说明

### config/ai_config.json

```json
{
  "deepseek_api_key": "sk-...",
  "daily_budget": 10.0,
  "monthly_budget": 200.0,
  "warning_threshold": 0.8,
  "monitor_keyword": "客户"  ← 全局监听关键词
}
```

**修改方式**:
1. 通过前端"系统设置"页面（推荐）
2. 直接编辑配置文件

**注意**: 修改后需要重启后端服务！

---

## 🚀 快速开始

### 1. 一键启动（推荐）

```bash
双击运行: start_servers.bat
```

这个脚本会自动：
- ✅ 启动后端服务
- ✅ 启动前端服务
- ✅ 打开浏览器

### 2. 配置监听关键词

访问 http://localhost:5173，在首页顶部设置关键词为 `客户`。

### 3. 修改微信联系人

将测试联系人改名为 `客户-测试`。

### 4. 测试

1. 给"客户-测试"发送消息
2. 查看消息中心是否显示
3. 选择 AI 专家，生成回复

### 5. 停止服务

```bash
双击运行: stop_servers.bat
```

---

## ❓ 常见问题

### Q1: 为什么消息中心没有显示消息？

**检查清单**:
- [ ] 联系人名称是否以关键词开头？
- [ ] 关键词是否正确（区分大小写）？
- [ ] 后端服务是否正在运行？
- [ ] 修改配置后是否重启了后端？

### Q2: 如何修改监听关键词？

1. 进入"系统设置"页面
2. 修改"全局监听关键词"
3. 保存配置
4. **重启后端服务**

### Q3: 可以同时监听多个关键词吗？

不可以。当前版本只支持一个全局关键词。

如果需要监听多种类型的联系人，建议：
- 使用统一的前缀，例如 `监听-`
- 联系人命名：`监听-客户-张三`、`监听-代理-李四`

### Q4: AI 专家选择在哪里？

在消息中心右侧的"AI 智能回复"面板中，点击"生成回复"按钮上方有一个下拉菜单。

### Q5: 如何创建多个 AI 专家？

1. 进入"AI 专家搭建"页面
2. 点击"新建配置"
3. 填写不同的配置信息
4. 保存

每个配置都会出现在下拉菜单中。

---

## 🔧 技术细节

### 监听器实现

**文件**: `python/message_listener.py`

```python
# 加载全局关键词
self.monitor_keyword = self._load_monitor_keyword()

# 过滤逻辑
if not nickname.startswith(self.monitor_keyword):
    continue  # 跳过不匹配的会话
```

### API 端点

**生成回复**:
```
POST /api/ai/generate
{
  "session_id": "客户-张三",
  "customer_message": "你好",
  "prompt_id": 1  ← 用户选择的 AI 专家 ID
}
```

**获取配置**:
```
GET /api/ai/config
```

**更新配置**:
```
PUT /api/ai/config
{
  "monitor_keyword": "客户"
}
```

---

## 📝 更新日志

### v2.0 (当前版本)

**新增**:
- ✅ 全局唯一监听关键词
- ✅ 用户手动选择 AI 专家
- ✅ 系统设置页面
- ✅ 配置管理 API

**废弃**:
- ❌ 多关键词匹配规则表 (keyword_rules)
- ❌ 自动匹配 AI 专家

**改进**:
- 🔧 简化监听逻辑
- 🔧 移除错误的身份判定修正
- 🔧 优化用户体验

---

**开始使用吧！** 🎉

