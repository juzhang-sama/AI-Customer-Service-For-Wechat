# 会话功能技术文档

## 一、功能概述

"会话"功能是本项目的核心功能，实现了**微信消息的实时监听、同步和展示**。系统通过 Python 后端监听微信 PC 客户端的 UI 变化，将消息推送到前端展示，并支持 AI 智能回复生成。

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Electron 应用                                  │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    React 前端 (Vite)                             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │   │
│  │  │ MessageContext  │  │ MessageCenter   │  │ InlineReply     │  │   │
│  │  │ (全局状态管理)   │  │ (会话UI组件)    │  │ Generator       │  │   │
│  │  └────────┬────────┘  └────────┬────────┘  └─────────────────┘  │   │
│  │           │ SSE 连接           │                                 │   │
│  └───────────┼────────────────────┼─────────────────────────────────┘   │
└──────────────┼────────────────────┼─────────────────────────────────────┘
               │                    │
               ▼                    │
┌─────────────────────────────────────────────────────────────────────────┐
│                      Python Flask 后端 (api_server.py)                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐ │
│  │ /api/messages/  │  │ message_queue   │  │ WeChatMessageListener   │ │
│  │ stream (SSE)    │◄─┤ (内存队列)      │◄─┤ (消息监听线程)          │ │
│  └─────────────────┘  └─────────────────┘  └───────────┬─────────────┘ │
└───────────────────────────────────────────────────────┼─────────────────┘
                                                        │ uiautomation
                                                        ▼
                                              ┌─────────────────────┐
                                              │   微信 PC 客户端     │
                                              │  (WeChatMainWndForPC)│
                                              └─────────────────────┘
```

---

## 三、核心类与模块

### 3.1 后端核心类

#### 3.1.1 `WeChatMessageListener` (python/message_listener.py)

**职责**: 监听微信 PC 客户端的会话列表变化，解析消息并推送

**关键属性**:
| 属性 | 类型 | 说明 |
|------|------|------|
| `window` | WindowControl | 微信主窗口句柄 |
| `session_list` | ListControl | 会话列表控件 |
| `last_states` | dict | 记录每个会话的上次状态，用于检测变化 |
| `monitor_keyword` | str | 监听关键词过滤（默认"客户"）|
| `monitor_match_mode` | str | 匹配模式: contains/startswith/exact |
| `callback` | function | 新消息回调函数 |

**关键方法**:

```python
def find_window(self):
    """查找微信窗口，支持多种查找策略"""
    # 1. 通过类名查找 (最稳妥)
    # 2. 通过中英文名称查找
    # 3. 模糊匹配兜底

def parse_session_name(self, name):
    """
    解析微信会话列表项的 Name 属性
    返回: (session_name, unread_count, content, is_self, display_sender, time_tag)
    """

def scan(self):
    """
    扫描会话列表，检测消息变化
    核心逻辑:
    1. 遍历会话列表项
    2. 解析每个会话的状态
    3. 与 last_states 对比检测变化
    4. 触发 callback 推送新消息
    """
```

**消息发送者判定逻辑** (核心算法):
```python
# 判定规则:
# 1. unread > 0 → 100% 是对方发来的消息
# 2. unread == 0 且内容有"我:"前缀 → 我的消息
# 3. unread == 0 且状态变化 → 根据之前状态推断
```

#### 3.1.2 `api_server.py` (python/api_server.py)

**职责**: Flask HTTP 服务器，提供 REST API 和 SSE 消息流

**核心端点**:
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/messages/stream` | GET | SSE 实时消息流 |
| `/api/send` | POST | 发送微信消息 |
| `/api/status` | GET | 检查微信连接状态 |

**SSE 消息流实现**:
```python
@app.route('/api/messages/stream')
def stream_messages():
    def event_stream():
        last_sent_index = len(message_queue)
        while True:
            # 检查新消息
            if len(message_queue) > last_sent_index:
                new_msgs = message_queue[last_sent_index:]
                for msg in new_msgs:
                    yield f"data: {json.dumps(msg)}\n\n"
            # 心跳包 (每15秒)
            yield f"data: {json.dumps({'type': 'heartbeat'})}\n\n"
            time.sleep(1)
    return Response(event_stream(), mimetype="text/event-stream")
```

**消息回调处理**:
```python
def on_new_message(msg):
    # 1. 更新内存队列 (最多保留50条)
    with message_lock:
        message_queue.append(msg)
        if len(message_queue) > 50:
            message_queue.pop(0)

    # 2. 持久化入队 (AI预生成)
    queue_manager.enqueue_message(session_id, customer_name, content)
```

#### 3.1.3 `WeChatAutomation` (python/wechat_auto.py)

**职责**: 微信 UI 自动化操作（发送消息）

**关键方法**:
```python
def send_message(self, who, message):
    """
    发送消息流程:
    1. 激活微信窗口
    2. 点击搜索框，输入联系人名称
    3. 选择搜索结果
    4. 验证会话标题 (防止发错人)
    5. 输入消息内容并发送
    """
```

---

### 3.2 前端核心模块

#### 3.2.1 `MessageContext` (src/contexts/MessageContext.tsx)

**职责**: 全局消息状态管理，维护 SSE 连接

**核心状态**:
```typescript
interface MessageContextType {
    sessions: Record<string, ChatSession>;  // 所有会话
    activeSessionId: string | null;         // 当前选中会话
    isConnected: boolean;                   // SSE 连接状态
    isRetrying: boolean;                    // 是否正在重连
}

interface ChatSession {
    id: string;
    lastMessage: string;
    lastTime: string;
    unreadCount: number;
    messages: Message[];
}

interface Message {
    session: string;
    sender: string;
    content: string;
    unread: number;
    is_self: boolean;
    time: string;
}
```

**SSE 连接管理**:
- 自动重连机制 (5秒间隔)
- 心跳监控 (30秒超时检测)
- 僵尸连接自动恢复

**数据持久化**:
- 使用 `localStorage` 保存会话数据
- 页面刷新后自动恢复

#### 3.2.2 `MessageCenter` (src/components/MessageCenter.tsx)

**职责**: 会话列表和聊天界面 UI 组件

**布局结构**:
```
┌──────────────────────────────────────────────────────────────┐
│ ┌──────────┐ ┌─────────────────────────┐ ┌────────────────┐ │
│ │ 会话列表  │ │      聊天区域           │ │ AI回复生成器   │ │
│ │ (左侧)   │ │      (中间)             │ │ (右侧)        │ │
│ │          │ │                         │ │               │ │
│ │ - 会话1  │ │ [对方消息]              │ │ 智能回复建议   │ │
│ │ - 会话2  │ │         [我的消息]      │ │               │ │
│ │ - 会话3  │ │ [对方消息]              │ │               │ │
│ └──────────┘ └─────────────────────────┘ └────────────────┘ │
└──────────────────────────────────────────────────────────────┘
```

**功能特性**:
- 会话按最后消息时间排序
- 未读消息红点提示
- 删除会话/删除单条消息
- 消息自动滚动到底部


---

## 四、数据流详解

### 4.1 消息接收流程

```
微信PC客户端 (UI变化)
        │
        ▼ uiautomation 轮询 (1秒间隔)
┌───────────────────────────────────┐
│ WeChatMessageListener.scan()      │
│ 1. 获取会话列表 GetChildren()     │
│ 2. 解析每个会话项                 │
│ 3. 对比 last_states 检测变化      │
│ 4. 关键词过滤 (monitor_keyword)   │
└───────────────────────────────────┘
        │ callback(msg_data)
        ▼
┌───────────────────────────────────┐
│ on_new_message() 回调             │
│ 1. 加入 message_queue (内存)      │
│ 2. 入队 AI 预生成任务             │
└───────────────────────────────────┘
        │ SSE 推送
        ▼
┌───────────────────────────────────┐
│ MessageContext.connectSSE()       │
│ es.onmessage → setSessions()      │
└───────────────────────────────────┘
        │ React 状态更新
        ▼
┌───────────────────────────────────┐
│ MessageCenter 组件重新渲染        │
└───────────────────────────────────┘
```

### 4.2 消息数据结构

**后端推送格式**:
```json
{
    "session": "客户-张三",
    "sender": "客户-张三",
    "content": "你好",
    "unread": 1,
    "is_self": false,
    "time": "14:30:25"
}
```

---

## 五、配置说明

**配置文件**: `config/ai_config.json`

```json
{
    "monitor_keyword": "客户",
    "monitor_match_mode": "contains"
}
```

| 模式 | 说明 |
|------|------|
| `contains` | 包含关键词 (推荐) |
| `startswith` | 以关键词开头 |
| `exact` | 精确匹配 |

---

## 六、关键文件清单

| 文件路径 | 说明 |
|----------|------|
| `python/api_server.py` | Flask API 服务器 |
| `python/message_listener.py` | 微信消息监听器 |
| `python/wechat_auto.py` | 微信 UI 自动化 |
| `src/contexts/MessageContext.tsx` | 全局消息状态 |
| `src/components/MessageCenter.tsx` | 会话 UI 组件 |
| `config/ai_config.json` | 监听关键词配置 |

---

## 七、常见问题

**Q1: 消息监听不到？**
- 检查微信是否已登录
- 确认联系人名称包含关键词
- 查看后端控制台日志

**Q2: 消息发送者判断错误？**
- 核心依据是**未读数**：有未读=对方消息，无未读=我的消息

